import{_ as m,a as h,o as n,c as o,b as a,e as c,i as y,v as g,F as w,j as x,t as d,d as _,n as p}from"./index-34d007ee.js";const S={name:"MisPlanes",data(){return{misSolicitudes:[],loading:!1,searchQuery:"",cancellingIds:[]}},methods:{isPlanSolicitud(t){if(!t)return!1;const e=Number(t.plan_id),i=Number(t.rutina_id);return!isNaN(e)&&e>0&&(isNaN(i)||i<=0)},async fetchSolicitudes(){this.loading=!0;try{const t=await h.get("/api/solicitudes/mis");if(t&&t.ok){const e=await t.json();this.misSolicitudes=Array.isArray(e)?e.filter(i=>i&&(i.estado||"").toString().toLowerCase()!=="cancelado"):[],this.misSolicitudes=this.misSolicitudes.filter(i=>this.isPlanSolicitud(i))}}catch(t){console.error("fetch mis solicitudes failed",t)}this.loading=!1},openPlanDetail(t){t&&this.$router.push(`/cliente/plan/${t}`)},canViewPlan(t){try{if(!t)return!1;const e=(t.estado||"").toString().toLowerCase();return e==="aceptado"||e==="aceptada"||e==="accepted"}catch{return!1}},async cancelarSolicitud(t){if(t){this.cancellingIds.includes(t)||this.cancellingIds.push(t);try{const e=await h.del(`/api/solicitudes/${t}`);if(e&&e.ok)this.misSolicitudes=(this.misSolicitudes||[]).filter(i=>i.id!==t);else{const i=await e.json().catch(()=>({}));throw new Error(i.error||"Error cancelando solicitud")}}catch(e){console.error("cancelarSolicitud failed",e);try{alert("No se pudo cancelar la solicitud: "+(e.message||e))}catch{}}finally{const e=this.cancellingIds.indexOf(t);e!==-1&&this.cancellingIds.splice(e,1)}}},statusClass(t){if(!t)return"";const e=t.toString().toLowerCase();return e==="aceptado"||e==="aceptada"?"text-green-600":e==="pendiente"?"text-yellow-600":e==="cancelado"?"text-red-600":""},openPlanFromSolicitud(t){if(!t)return;if(!this.canViewPlan(t)){try{alert("El entrenador no ha autorizado ver este plan todavía.")}catch{}return}const e=t.plan_id;if(e){this.$router.push({path:`/cliente/plan/${e}`,query:{solicitudId:t.id}});return}if(t.rutina_id){try{alert("Aún no hay un plan asignado a esta solicitud. Intenta más tarde o contacta con tu entrenador.")}catch{}return}try{alert("Solicitud inválida: sin rutina ni plan asociado.")}catch{}}},mounted(){this.fetchSolicitudes()},computed:{filteredSolicitudes(){const t=(this.searchQuery||"").trim().toLowerCase();return t?(this.misSolicitudes||[]).filter(e=>{const i=(e.rutina_nombre||"").toString().toLowerCase(),u=(e.nota||"").toString().toLowerCase();return i.includes(t)||u.includes(t)||(e.estado||"").toLowerCase().includes(t)}):this.misSolicitudes||[]}}},b={class:"p-6"},v={class:"bg-white p-4 rounded shadow"},C={class:"flex items-center justify-between mb-4"},k={key:0},P={class:"w-1/3"},N={key:0},V={key:0,class:"text-sm text-gray-600"},L={class:"mt-2 space-y-2"},I={class:"flex justify-between items-start"},E={class:"flex-1"},M={class:"font-semibold"},j={class:"text-sm text-gray-600"},B={key:0,class:"text-sm mt-1"},D={class:"ml-4 flex-shrink-0 space-y-2"},F={class:"space-x-2"},Q=["disabled","onClick","title"],z=["onClick","disabled"],A={key:0,class:"text-sm text-red-600"};function q(t,e,i,u,l,r){return n(),o("div",b,[e[3]||(e[3]=a("h1",{class:"text-2xl font-bold mb-4"},"Mis Planes Nutricionales",-1)),a("div",v,[a("div",C,[l.loading?(n(),o("div",k,"Cargando tus solicitudes...")):c("",!0),a("div",P,[y(a("input",{"onUpdate:modelValue":e[0]||(e[0]=s=>l.searchQuery=s),placeholder:"Buscar en mis solicitudes...",class:"w-full px-3 py-2 border rounded"},null,512),[[g,l.searchQuery]])])]),l.loading?c("",!0):(n(),o("div",N,[e[2]||(e[2]=a("h3",{class:"font-semibold mb-2"},"Mis Solicitudes de Plan",-1)),l.misSolicitudes.length===0?(n(),o("div",V,"No has solicitado ningún plan aún.")):c("",!0),a("ul",L,[(n(!0),o(w,null,x(r.filteredSolicitudes,s=>(n(),o("li",{key:s.id,class:"p-3 border rounded bg-white"},[a("div",I,[a("div",E,[a("div",M,d(s.rutina_nombre||"Plan "+(s.plan_id||s.id)),1),a("div",j,[e[1]||(e[1]=_("Estado: ",-1)),a("span",{class:p(r.statusClass(s.estado))},d(s.estado),3),_(" — "+d(s.creado_en?new Date(s.creado_en).toLocaleString():""),1)]),s.nota?(n(),o("div",B,"Nota: "+d(s.nota),1)):c("",!0)]),a("div",D,[a("div",F,[a("button",{disabled:!r.canViewPlan(s),onClick:f=>r.openPlanFromSolicitud(s),title:r.canViewPlan(s)?"Ver plan":"El entrenador no ha autorizado ver este plan",class:p(["px-3 py-1 rounded",r.canViewPlan(s)?"bg-blue-600 text-white":"bg-gray-300 text-gray-600 cursor-not-allowed"])}," Ver plan ",10,Q),s.estado!=="cancelado"?(n(),o("button",{key:0,onClick:f=>r.cancelarSolicitud(s.id),disabled:l.cancellingIds.includes(s.id),class:"px-3 py-1 bg-red-600 text-white rounded"},d(l.cancellingIds.includes(s.id)?"Cancelando...":"Cancelar"),9,z)):c("",!0)]),s.estado==="cancelado"?(n(),o("div",A,"Solicitud cancelada")):c("",!0)])])]))),128))])]))])])}const O=m(S,[["render",q],["__scopeId","data-v-ce200a25"]]);export{O as default};
