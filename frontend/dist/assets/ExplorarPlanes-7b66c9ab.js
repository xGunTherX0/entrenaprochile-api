import{_ as b,a as u,r as y,o,c as d,b as n,i as m,v as x,n as p,F as g,j as _,t as c,g as v,w as P,d as w}from"./index-34d007ee.js";const k={name:"ExplorarPlanes",data(){return{planes:[],loading:!1,loadingIds:[],requestedPlanIds:[],searchQuery:"",selectedTrainerId:null,page:1,pageSize:6}},computed:{trainers(){const s=Array.isArray(this.planes)?this.planes:[],e={};for(let i=0;i<s.length;i++){const r=s[i],l=r&&(r.entrenador_id!=null?r.entrenador_id:"_"+(r.entrenador_nombre||""));e[l]||(e[l]={entrenador_id:r?r.entrenador_id:null,entrenador_nombre:r?r.entrenador_nombre:null,entrenador_id_usuario:r?r.entrenador_usuario_id:null})}return Object.keys(e).map(i=>e[i])},filteredPlanes(){let s=Array.isArray(this.planes)?this.planes.slice():[];if(this.selectedTrainerId&&(s=s.filter(e=>e&&e.entrenador_id===this.selectedTrainerId)),this.searchQuery&&this.searchQuery.trim().length>0){const e=this.searchQuery.trim().toLowerCase();s=s.filter(i=>i&&((i.nombre||"").toLowerCase().includes(e)||(i.descripcion||"").toLowerCase().includes(e)))}return s},totalPages(){return Math.max(1,Math.ceil((this.filteredPlanes||[]).length/this.pageSize))},paginatedPlanes(){const s=(this.page-1)*this.pageSize;return(this.filteredPlanes||[]).slice(s,s+this.pageSize)}},methods:{onSearch(){this.page=1},selectTrainer(s){this.selectedTrainerId=s,this.page=1},async fetchPlanes(){this.loading=!0;try{const s=await u.get("/api/planes",{skipAuth:!0});s&&s.ok&&(this.planes=await s.json())}catch(s){console.error("fetchPlanes failed",s)}finally{this.loading=!1}},async fetchMisSolicitudes(){try{const s=await u.get("/api/solicitudes/mis");if(s&&s.ok){const e=await s.json();this.requestedPlanIds=Array.isArray(e)?e.filter(i=>i&&(()=>{const r=Number(i.plan_id);return!isNaN(r)&&r>0&&(i.estado==="pendiente"||i.estado==="aceptado")})()).map(i=>Number(i.plan_id)):[]}}catch{}},openPlanDetail(s){s&&this.$router.push(`/cliente/plan/${s}`)},async elegirPlan(s){if(s){this.loadingIds.includes(s)||this.loadingIds.push(s);try{const e=await u.post(`/api/planes/${s}/solicitar`),i=await(e&&e.json?e.json().catch(()=>({})):Promise.resolve({}));if(e&&e.ok){try{const r=i.estado||"pendiente";(r==="pendiente"||r==="aceptado")&&!this.requestedPlanIds.includes(s)&&this.requestedPlanIds.push(s)}catch{}this.$router.push("/cliente/planes")}else throw new Error(i.error||"Error al elegir plan")}catch(e){console.error("elegirPlan failed",e);try{alert("No se pudo elegir el plan: "+(e.message||e))}catch{}}finally{const e=this.loadingIds.indexOf(s);e!==-1&&this.loadingIds.splice(e,1)}}}},mounted(){this.fetchPlanes(),this.fetchMisSolicitudes()}},C={class:"p-6"},I={class:"bg-white p-4 rounded shadow"},S={class:"flex items-start justify-between mb-4"},T={class:"w-1/3"},j={class:"w-60 trainer-list"},E={class:"space-y-2"},N=["onClick"],A={key:0,class:"bg-white p-4 rounded shadow"},q={key:1},Q={key:0,class:"text-sm text-gray-600"},V={key:1},z={class:"grid grid-cols-1 gap-4"},M={class:"font-semibold"},B={class:"text-sm text-gray-600"},D={class:"text-xs text-gray-500"},L={class:"space-x-2"},F=["onClick"],O=["onClick","disabled"],U={class:"mt-4 flex items-center justify-center space-x-2"},G=["disabled"],H=["disabled"];function J(s,e,i,r,l,a){const f=y("router-link");return o(),d("div",C,[e[7]||(e[7]=n("h1",{class:"text-2xl font-bold mb-4"},"Explorar Planes Nutricionales",-1)),n("div",I,[n("div",S,[n("div",T,[m(n("input",{"onUpdate:modelValue":e[0]||(e[0]=t=>l.searchQuery=t),onInput:e[1]||(e[1]=(...t)=>a.onSearch&&a.onSearch(...t)),placeholder:"Buscar por nombre o descripción...",class:"w-full px-3 py-2 border rounded"},null,544),[[x,l.searchQuery]])]),n("aside",j,[e[6]||(e[6]=n("h3",{class:"font-semibold mb-2"},"Entrenadores",-1)),n("div",E,[n("button",{class:p([{"font-semibold text-blue-600":l.selectedTrainerId===null},"px-2 py-1 rounded bg-gray-50 w-full text-left"]),onClick:e[2]||(e[2]=t=>a.selectTrainer(null))},"Todos",2),(o(!0),d(g,null,_(a.trainers,t=>(o(),d("div",{key:t.entrenador_id,class:"flex items-center justify-between"},[n("button",{onClick:h=>a.selectTrainer(t.entrenador_id),class:p([{"font-semibold text-blue-600":l.selectedTrainerId===t.entrenador_id},"px-2 py-1 rounded bg-gray-50 w-full text-left"])},c(t.entrenador_nombre||"—"),11,N),v(f,{to:{name:"EntrenadorPublico",params:{id:t.entrenador_id_usuario||t.entrenador_id}},class:"ml-2 text-sm text-blue-600"},{default:P(()=>[...e[5]||(e[5]=[w("Ver perfil",-1)])]),_:1},8,["to"])]))),128))])])]),l.loading?(o(),d("div",A,"Cargando planes...")):(o(),d("div",q,[a.filteredPlanes.length===0?(o(),d("div",Q,"No hay planes públicos disponibles.")):(o(),d("div",V,[n("div",z,[(o(!0),d(g,null,_(a.paginatedPlanes,t=>(o(),d("div",{key:t.id,class:"p-3 border rounded bg-gray-50 flex justify-between items-center"},[n("div",null,[n("div",M,c(t.nombre),1),n("div",B,c(t.descripcion),1),n("div",D,"Por: "+c(t.entrenador_nombre||"—"),1)]),n("div",L,[n("button",{onClick:h=>a.openPlanDetail(t.id),class:"px-3 py-1 bg-blue-600 text-white rounded"},"Ver",8,F),n("button",{onClick:h=>a.elegirPlan(t.id),disabled:l.loadingIds.includes(t.id)||l.requestedPlanIds.includes(t.id),class:"px-3 py-1 bg-green-600 text-white rounded"},c(l.loadingIds.includes(t.id)?"Elegiendo...":l.requestedPlanIds.includes(t.id)?"Solicitud pendiente":"Elegir plan"),9,O)])]))),128))]),n("div",U,[n("button",{disabled:l.page<=1,onClick:e[3]||(e[3]=t=>l.page--),class:"px-3 py-1 border rounded"},"Anterior",8,G),n("div",null,"Página "+c(l.page)+" / "+c(a.totalPages),1),n("button",{disabled:l.page>=a.totalPages,onClick:e[4]||(e[4]=t=>l.page++),class:"px-3 py-1 border rounded"},"Siguiente",8,H)])]))]))])])}const R=b(k,[["render",J]]);export{R as default};
